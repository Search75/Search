<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Search</title>
    <!-- স্টাইলগুলো index.html এর মতোই, তাই কপি-পেস্ট করা হয়েছে -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: #333; }
        .container { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; transition: all 0.3s ease; }
        .container:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        h1 { color: #764ba2; margin-bottom: 25px; font-weight: 700; }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #764ba2; }
        button { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 700; transition: opacity 0.3s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        p { margin-top: 20px; color: #777; }
        a { color: #667eea; text-decoration: none; font-weight: 500; }
        .hidden { display: none; }
        #message { margin-top: 15px; font-weight: 500; color: red; }
        .links { display: flex; justify-content: space-between; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="login-form">
            <h1>Welcome Back!</h1>
            <form onsubmit="sendLoginOtp(event)">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" id="login-btn">Login</button>
            </form>
            <div class="links">
                <a href="reset.html">Forgot Password?</a>
                <a href="signup.html">Create an account</a>
            </div>
        </div>

        <!-- OTP Verification Form -->
        <div id="otp-form" class="hidden">
            <h1>Verify Login</h1>
            <p>An OTP has been sent to your email.</p>
            <form onsubmit="verifyLoginOtp(event)">
                <div class="form-group">
                    <label for="otp">Enter OTP</label>
                    <input type="text" id="otp" required>
                </div>
                <button type="submit" id="verify-btn">Verify & Login</button>
            </form>
        </div>
        <p id="message"></p>
    </div>
    
    <!-- SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCEIZmnV6vlnDHuXkR55czI7ZaNmDndRSk",
            authDomain: "search-75.firebaseapp.com",
            projectId: "search-75",
            storageBucket: "search-75.firebasestorage.app",
            messagingSenderId: "1080878455131",
            appId: "1:1080878455131:web:87e15a4e2c1cb02ecb227e",
            measurementId: "G-YGLHPK8DHW"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        const EMAILJS_PUBLIC_KEY = 'J_kwrx1EFBtl5gA6Y';
        const EMAILJS_SERVICE_ID = 'service_w3lekhk';
        const EMAILJS_TEMPLATE_ID = 'template_otp';
        emailjs.init(EMAILJS_PUBLIC_KEY);

        const loginForm = document.getElementById('login-form');
        const otpForm = document.getElementById('otp-form');
        const messageEl = document.getElementById('message');
        const loginBtn = document.getElementById('login-btn');
        const verifyBtn = document.getElementById('verify-btn');

        async function sendLoginOtp(event) {
            event.preventDefault();
            messageEl.textContent = '';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Preparing...';
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                // প্রথমে পাসওয়ার্ড ঠিক আছে কিনা তা চেক করার চেষ্টা করি
                // signInWithEmailAndPassword দিয়ে সরাসরি লগইন না করে, আমরা শুধু ক্রেডেনশিয়াল ভ্যালিড কিনা চেক করবো।
                // Firebase সরাসরি এই সুবিধা দেয় না, তাই আমরা একটি ভিন্ন পদ্ধতি ব্যবহার করবো।
                // এখানে আমরা সরাসরি OTP পাঠিয়ে দিচ্ছি। যদি পাসওয়ার্ড ভুল হয়, তাহলে ভেরিফিকেশনের পর লগইন ফেইল হবে।
                
                const generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
                
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                    to_name: "User",
                    to_email: email,
                    otp_code: generatedOtp
                });
                
                sessionStorage.setItem('loginData', JSON.stringify({ email, password, otp: generatedOtp }));
                
                loginForm.classList.add('hidden');
                otpForm.classList.remove('hidden');
                messageEl.textContent = `An OTP has been sent to ${email}`;
                messageEl.style.color = 'green';

            } catch (error) {
                messageEl.textContent = "Failed to send OTP. Check your email and try again.";
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        async function verifyLoginOtp(event) {
            event.preventDefault();
            messageEl.textContent = '';
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Logging in...';

            const enteredOtp = document.getElementById('otp').value;
            const storedData = JSON.parse(sessionStorage.getItem('loginData'));

            if (!storedData || enteredOtp !== storedData.otp) {
                messageEl.textContent = 'Invalid OTP.';
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify & Login';
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(storedData.email, storedData.password);
                sessionStorage.removeItem('loginData');
                window.location.href = 'app.html';
            } catch (error) {
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    messageEl.textContent = 'Invalid email or password.';
                } else {
                    messageEl.textContent = error.message;
                }
                // ভুল হলে আবার লগইন পেজে ফেরত পাঠানো
                setTimeout(() => {
                    loginForm.classList.remove('hidden');
                    otpForm.classList.add('hidden');
                }, 2000);
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify & Login';
            }
        }
    </script>
</body>
</html>